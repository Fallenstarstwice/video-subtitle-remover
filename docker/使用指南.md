# Docker 部署指南

## 前置要求

### 验证 GPU 支持
```bash
# 检查 Docker 是否能识别 GPU
docker run --rm --gpus all nvidia/cuda:12.8.0-base-ubuntu22.04 nvidia-smi
```

如果显示 GPU 信息，说明配置成功。

## 快速开始

### 1. 准备文件结构

在项目根目录创建以下目录结构：
```
video-subtitle-remover/
├── videos/              # 放置输入视频和 Excel 文件
│   └── videos.xlsx
├── output/              # 输出目录（自动创建）
├── docker-compose.yml
└── docker/
    └── Dockerfile
```

### 2. 构建镜像

```bash
docker-compose build
```

### 3. 运行容器

#### 方式一：使用 docker-compose（推荐）

```bash
# 运行默认命令（处理 videos.xlsx）
docker-compose up

# 如果需要指定不同的 Excel 文件
docker-compose run video-subtitle-remover python cut_and_remove/main.py /vsr/videos/my_videos.xlsx

# 指定自定义输出目录
docker-compose run video-subtitle-remover python cut_and_remove/main.py /vsr/videos/videos.xlsx --output /vsr/output/custom
```

#### 方式二：使用 docker run

```bash
# 基本运行
docker run -it --rm --gpus all \
  -v d:\Project\video-subtitle-remover\videos:/vsr/videos \
  -v d:\Project\video-subtitle-remover\output:/vsr/output \
  video-subtitle-remover:cu12.8 \
  python cut_and_remove/main.py /vsr/videos/videos.xlsx

# 自定义参数运行
docker run -it --rm --gpus all \
  -v d:\videos:/vsr/videos \
  -v d:\output:/vsr/output \
  video-subtitle-remover:cu12.8 \
  python cut_and_remove/main.py /vsr/videos/videos.xlsx --output /vsr/output --verbose
```

### 4. 查看结果

处理完成后，在 `output/final/` 目录查看结果：
```
output/
├── final/              # 最终视频（去字幕后）
│   ├── video1_no_sub.mp4
│   └── video2_no_sub.mp4
└── intermediate/       # 中间视频（如果 keep_intermediate: true）
    └── ...
```

## 常用命令

### 构建相关
```bash
# 重新构建镜像（不使用缓存）
docker-compose build --no-cache

# 构建并启动
docker-compose up --build

# 只构建不运行
docker-compose build
```

### 运行相关
```bash
# 启动容器（后台运行）
docker-compose up -d

```


## 高级配置

### 修改 CUDA 版本

编辑 [docker-compose.yml](docker-compose.yml:13)：
```yaml
build:
  args:
    CUDA_VERSION: "13.0"  # 改为 13.0
```

然后重新构建：
```bash
docker-compose build --no-cache
```

### 自定义输出目录

#### 方式一：修改 docker-compose.yml
```yaml
volumes:
  - ./my_output:/vsr/output  # 改为自定义目录
```

#### 方式二：命令行指定
```bash
docker-compose run \
  -v d:\custom_output:/vsr/output \
  video-subtitle-remover \
  python cut_and_remove/main.py /vsr/videos/videos.xlsx --output /vsr/output
```

### 限制 GPU 使用

```yaml
deploy:
  resources:
    reservations:
      devices:
        - driver: nvidia
          device_ids: ['0']  # 只使用 GPU 0
          capabilities: [gpu]
```

### 指定 GPU 内存限制

```bash
docker run -it --rm --gpus '"device=0,1"' \
  --gpus all \
  --shm-size=8g \
  video-subtitle-remover:cu12.8
```

## 故障排查

### 问题 1: GPU 不可用
```bash
# 检查 NVIDIA 驱动
nvidia-smi

# 检查 Docker GPU 支持
docker run --rm --gpus all nvidia/cuda:12.8.0-base-ubuntu22.04 nvidia-smi
```

### 问题 2: 权限错误
```bash
# Windows: 确保 Docker Desktop 使用 WSL 2 后端
# Linux: 使用 sudo 或将用户添加到 docker 组
sudo usermod -aG docker $USER
```

### 问题 3: 卷挂载路径错误
```bash
# Windows: 使用正斜杠或双反斜杠
-v d:/videos:/vsr/videos  # 正确
-v d:\videos:/vsr/videos  # 可能有问题（PowerShell 可以）
```

### 问题 4: 容器内找不到文件
```bash
# 进入容器检查文件结构
docker-compose exec video-subtitle-remover ls -la /vsr/videos
```

## 性能优化

### 使用 BuildKit 加速构建
```bash
# Windows PowerShell
$env:DOCKER_BUILDKIT=1
docker-compose build

# Linux
DOCKER_BUILDKIT=1 docker-compose build
```

### 使用缓存挂载
Dockerfile 已配置缓存挂载，依赖包会被缓存以加速后续构建。



